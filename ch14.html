<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>第14章 Bitonic Sort（バイトニックソート）</title><link rel="stylesheet" type="text/css" href="index.css" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><link rel="home" href="index.html" title="Java-OpenCL入門" /><link rel="up" href="pt04.html" title="パート IV. Java OpenCL実装" /><link rel="prev" href="ch13s07.html" title="13.7. FFT-2Dで画像処理" /><link rel="next" href="ch14s01.html" title="14.1. バイトニック配列の構築" /><meta xmlns="" name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0" /><script xmlns="" type="text/javascript" src="prettify/prettify.js"></script><link xmlns="" rel="stylesheet" type="text/css" href="prettify/skins/sons-of-obsidian.css" /><script xmlns="">
    window.addEventListener("load", function() {
      PR.prettyPrint();
	  });	
	</script><script xmlns="" type="text/javascript" src="script/head.js"></script></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><td width="20%" align="left"><a accesskey="p" href="ch13s07.html">戻る</a> </td><th width="60%" align="center"> </th><td width="20%" align="right"> <a accesskey="n" href="ch14s01.html">次へ</a></td></tr></table><hr /></div><div class="chapter"><div class="titlepage"><div><div><h2 class="title"><a id="_bitonic_sort_バイトニックソート"></a>第14章 Bitonic Sort（バイトニックソート）</h2></div></div></div><div class="toc"><p><strong>目次</strong></p><dl class="toc"><dt><span class="section"><a href="ch14s01.html">14.1. バイトニック配列の構築</a></span></dt><dt><span class="section"><a href="ch14s02.html">14.2. バイトニックマージ</a></span></dt><dt><span class="section"><a href="ch14s03.html">14.3. バイトニックソートのOpenCL実装例</a></span></dt><dt><span class="section"><a href="ch14s04.html">14.4. カーネルの実装（bitonic split）</a></span></dt><dt><span class="section"><a href="ch14s05.html">14.5. カーネルの実装（bitonic merge）</a></span></dt></dl></div><p>バイトニックソートは「Ken Batcher」が考案した並列ソートアルゴリズムです。完成度の高い並列化が可能なため、基数整列（radix sort）と同様にGPUでの整列アルゴリズムに適しています。</p><p>パフォーマンス上では、Radix Sortより劣りますが、一旦理解ができるようになると直感的に説明ができるようになることはアルゴリズムとしては大きな利点と言えるかと思います。</p><p>また並列コアを一定して使用させることができるため、最適化する余地が少ないことが、基数配列と比べて好まれる要因ともなっているようです。</p><p>バイトニック配列（またはシーケンス、シークエンス等）は以下の２つの式で表すことができます。</p><div class="informalfigure"><div class="mediaobject"><img src="images/bitonic_sequence_max.png" alt="images/bitonic_sequence_max.png" /></div></div><p>配列の要素はある一定の要素（配列の最大値）まで上昇し、そこから下降していきます。</p><div class="informalfigure"><div class="mediaobject"><img src="images/bitonic_sequence_min.png" alt="images/bitonic_sequence_min.png" /></div></div><p>もしくは配列の要素はある一定の要素（配列の最小値）まで下降し、そこから上昇していきます。本書ではバイトニックを一義的に前者として定義します。</p><p>バイトニックソートは、このバイトニック配列を２つのバイトニック配列にする「バイトニック分割（Bitonic Split）」を行い、片方は少ない値、もう片方は大きい値をとる配列に分割し、分割した配列を上昇形態と下降形態に整列する「バイトニック結合（Bitonic Merge）」を繰り返します。</p><p>バイトニック分割を具体的に行なう場合は、バイトニック配列の添字（インデックス）を２つに分けます。そして２つに分けた配列の要素を以下の式で比較します。</p><div class="informalfigure"><div class="mediaobject"><img src="images/bitonic_comparison.png" alt="images/bitonic_comparison.png" /></div></div><p>この式が成立した場合に、値をスワップ（入れ替え）します。これはバイトニック配列の上昇形態の部分の場合で、下降形態の部分配列では不等式は反対の方向性の関係を持ちます。</p><p>バイトニック結合は上昇形態と下降形態に分割された配列を結合（整列）します。結合は分割より一段低いnの値で上昇形態、下降形態に整列します。</p><p>バイトニック整列は複雑なので、一見理解できなくとも流れだけを見るとわかるようになるアルゴリズムです。まず具体的なアルゴリズムの手順をご覧いただきます。</p><p>バイトニック整列のアルゴリズムは、ステージ（Stage）というマクロレベルのステップ、ステージ内のサブステップとなるパス(Pass)からなります。</p><p>Stageが0の場合は、比較する要素の距離は1となり、ステージ1となると距離は2、ステージ2で距離が4、ステージ3で要素間の距離が8の比較を行います。データの要素数が増えるに従って処理すべきステージの総数は増加します。（原則として整列する配列は2の累乗のみ。0を挿入して2の累乗に補完するテクニックもあります。）</p><p>パス（Pass）は0の場合がやや特殊例となり、上昇・下降のバイトニック分割（Bitonic Split）に該当します。パスはステージが0の場合は0のみ、ステージが1の場合は0と1、ステージが2の場合は0と1と2というようにステージの回数に1を足した回数を繰り返します。</p><p>本書ではパスが0以外のステップをバイトニック結合（Bitonic Merge）として定義しますが、このバイトニック結合は、分割で決定された上昇形態となる配列インデックス（添字）、下降形態となる配列インデックス（添字）となるように整列をします。</p><p>分割と結合の具体的な過程は以下に具体例を出すのでそれで確認してください。</p><p>「表：Bitonic Split（Stage=0,Pass=0）」（<a class="xref" href="ch14.html#bitonic-split1" title="表14.1 表：Bitonic Split（Stage=0,Pass=0）">表14.1「表：Bitonic Split（Stage=0,Pass=0）」</a>）では、8つの配列要素を、各2つのバイトニック配列に分割しています。</p><p>データのインデックス（0,1,4,5）が上昇形態、(2,3,6,7)が下降形態とするバイトニック配列を作ります。</p><div class="table"><a id="bitonic-split1"></a><p class="title"><strong>表14.1 表：Bitonic Split（Stage=0,Pass=0）</strong></p><div class="table-contents"><table class="table" summary="表：Bitonic Split（Stage=0,Pass=0）" cellpadding="4px" style="border-collapse: collapse;border-top: 3px solid #527bbd; border-bottom: 3px solid #527bbd; border-left: 3px solid #527bbd; border-right: 3px solid #527bbd; "><colgroup><col class="col_1" /><col class="col_2" /><col class="col_3" /><col class="col_4" /><col class="col_5" /><col class="col_6" /><col class="col_7" /><col class="col_8" /><col class="col_9" /></colgroup><tbody><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">インデックス</pre></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">0</pre></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">1</pre></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">2</pre></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">3</pre></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">4</pre></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">5</pre></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">6</pre></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">7</pre></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">元シーケンス</pre></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">3</pre></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">7</pre></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">12</pre></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">98</pre></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">78</pre></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">66</pre></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">6</pre></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">5</pre></td></tr><tr><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">スプリット後</pre></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">3</pre></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">7</pre></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">98</pre></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">12</pre></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">66</pre></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">78</pre></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">6</pre></td><td style="" align="left" valign="top"><pre class="literallayout">5</pre></td></tr></tbody></table></div></div><br class="table-break" /><p>この例では以下のように不等式がなりたたない場合、各要素のスワップ（入れ替え）を行います。</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
【上昇形態】3 &lt; 7（インデックス：0と1）
</li><li class="listitem">
【下降形態】12 &gt; 98（インデックス：2と3）、要素をスワップ
</li><li class="listitem">
【上昇形態】78 &lt; 66（インデックス：4と5）、要素をスワップ
</li><li class="listitem">
【下降形態】6 &gt; 5（インデックス：6と7）
</li></ul></div><p>左半分【3,7,98,12】、【12,66,6,5】の2つのバイトニック配列に分割されました。</p><p>次の分割ステップ、「表：Bitonic Split（Stage=1,Pass=0）」（<a class="xref" href="ch14.html#bitonic-split2" title="表14.2 表：Bitonic Split（Stage=1,Pass=0）">表14.2「表：Bitonic Split（Stage=1,Pass=0）」</a>）では、２つのバイトニック配列を1つにします。</p><p>このステップでは、インデックスの（0,1,2,3）が上昇形態、(4,5,6,7)が下降形態とするバイトニック配列を作ります。</p><div class="table"><a id="bitonic-split2"></a><p class="title"><strong>表14.2 表：Bitonic Split（Stage=1,Pass=0）</strong></p><div class="table-contents"><table class="table" summary="表：Bitonic Split（Stage=1,Pass=0）" cellpadding="4px" style="border-collapse: collapse;border-top: 3px solid #527bbd; border-bottom: 3px solid #527bbd; border-left: 3px solid #527bbd; border-right: 3px solid #527bbd; "><colgroup><col class="col_1" /><col class="col_2" /><col class="col_3" /><col class="col_4" /><col class="col_5" /><col class="col_6" /><col class="col_7" /><col class="col_8" /><col class="col_9" /></colgroup><tbody><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">インデックス</pre></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">0</pre></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">1</pre></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">2</pre></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">3</pre></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">4</pre></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">5</pre></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">6</pre></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">7</pre></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">元シーケンス</pre></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">3</pre></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">7</pre></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">98</pre></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">12</pre></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">66</pre></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">78</pre></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">6</pre></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">5</pre></td></tr><tr><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">スプリット後</pre></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">3</pre></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">7</pre></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">98</pre></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">12</pre></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">66</pre></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">78</pre></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">6</pre></td><td style="" align="left" valign="top"><pre class="literallayout">5</pre></td></tr></tbody></table></div></div><br class="table-break" /><p>上記の表では以下の不等式とスワップが行なわれます。</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
3 &lt; 98（インデックス：0と2）
</li><li class="listitem">
7 &lt; 12（インデックス：1と3）
</li><li class="listitem">
66 &gt; 6（インデックス：4と6）
</li><li class="listitem">
78 &gt; 5（インデックス：5と7）
</li></ul></div><p>比較の結果、要素のスワップは行われません。</p><p>「Bitonic Split（Stage=1,Pass=0）」（<a class="xref" href="ch14.html#bitonic-split2" title="表14.2 表：Bitonic Split（Stage=1,Pass=0）">表14.2「表：Bitonic Split（Stage=1,Pass=0）」</a>）は分割したのみで、バイトニック整列の構成用件を満たしません。左半分が上昇形態、右半分が下降形態とするならば、【3,7,12,98】, 【78,66,6,5】とならなければなりません。</p><p>ここでバイトニック結合（Merge）という分割の後の整列処理を行う必要があります。Stage=1、Pass=0（本書ではPassが0の時にバイトニック分割、それ以外はまバイトニック結合と定義）から、Stage=1、Pass=1のマージは以下の「表：Bitonic Merge（Stage=1,Pass=1）」（<a class="xref" href="ch14.html#bitonic-merge11" title="表14.3 表：Bitonic Merge（Stage=1,Pass=1）">表14.3「表：Bitonic Merge（Stage=1,Pass=1）」</a>）ようにします。</p><div class="table"><a id="bitonic-merge11"></a><p class="title"><strong>表14.3 表：Bitonic Merge（Stage=1,Pass=1）</strong></p><div class="table-contents"><table class="table" summary="表：Bitonic Merge（Stage=1,Pass=1）" cellpadding="4px" style="border-collapse: collapse;border-top: 3px solid #527bbd; border-bottom: 3px solid #527bbd; border-left: 3px solid #527bbd; border-right: 3px solid #527bbd; "><colgroup><col class="col_1" /><col class="col_2" /><col class="col_3" /><col class="col_4" /><col class="col_5" /><col class="col_6" /><col class="col_7" /><col class="col_8" /><col class="col_9" /></colgroup><tbody><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">インデックス</pre></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">0</pre></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">1</pre></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">2</pre></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">3</pre></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">4</pre></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">5</pre></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">6</pre></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">7</pre></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">元シーケンス</pre></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">3</pre></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">7</pre></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">98</pre></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">12</pre></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">66</pre></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">78</pre></td><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">6</pre></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">5</pre></td></tr><tr><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">スプリット後</pre></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">3</pre></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">7</pre></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">12</pre></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">98</pre></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">78</pre></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">66</pre></td><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout">6</pre></td><td style="" align="left" valign="top"><pre class="literallayout">5</pre></td></tr></tbody></table></div></div><br class="table-break" /><p>上記の表のマージでは（0,1,2,3）の上昇形態、(4,5,6,7)の下降形態に分けて整列を行います。</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
3 &lt; 7（インデックス：0と1）
</li><li class="listitem">
98 &lt; 12（インデックス：2と3）、要素をスワップ
</li><li class="listitem">
66 &gt; 78（インデックス：4と5）、要素をスワップ
</li><li class="listitem">
6 &gt; 5（インデックス：6と7）
</li></ul></div><p>これにより一つのバイトニック配列に結合が行われました。</p><p>最後にステージ3を行うとバイトニック配列から、整列された配列に置き換えることができます。ステージ2の段階でバイトニック配列ができており、配列を再分割することはできなくなっているため、ステージ3ではマージのみを行います。</p><p>このようにバイトニック分割（スプリット）と結合（マージ）を繰り返すことによって、整列化した配列に並び替えるのがバイトニック整列のアルゴリズムの標準実装です。</p></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="ch13s07.html">戻る</a> </td><td width="20%" align="center"><a accesskey="u" href="pt04.html">上に戻る</a></td><td width="40%" align="right"> <a accesskey="n" href="ch14s01.html">次へ</a></td></tr><tr><td width="40%" align="left" valign="top"> </td><td width="20%" align="center"><a accesskey="h" href="index.html">ホーム</a></td><td width="40%" align="right" valign="top"> </td></tr></table></div><wrapper xmlns=""><p>Copyright 2018-2019, by Masaki Komatsu</p>


</wrapper></body></html>