<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>C.1. Makefile</title><link rel="stylesheet" type="text/css" href="index.css" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><link rel="home" href="index.html" title="Java-OpenCL入門" /><link rel="up" href="apc.html" title="付録C Makeツール" /><link rel="prev" href="apc.html" title="付録C Makeツール" /><link rel="next" href="apcs02.html" title="C.2. cmake" /><meta xmlns="" name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0" /><script xmlns="" type="text/javascript" src="prettify/prettify.js"></script><link xmlns="" rel="stylesheet" type="text/css" href="prettify/skins/sons-of-obsidian.css" /><script xmlns="">
    window.addEventListener("load", function() {
      PR.prettyPrint();
	  });	
	</script><script xmlns="" type="text/javascript" src="script/head.js"></script></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><td width="20%" align="left"><a accesskey="p" href="apc.html">戻る</a> </td><th width="60%" align="center"> </th><td width="20%" align="right"> <a accesskey="n" href="apcs02.html">次へ</a></td></tr></table><hr /></div><div class="section"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a id="_makefile"></a>C.1. Makefile</h2></div></div></div><div class="note" style="margin-left: 0; margin-right: 10%;"><h3 class="title">注記</h3><p>JNIとJNAの項目に進む方はMakefileによるビルドを学ぶと便利です。</p></div><p>読者のC言語のバックグラウンドをお持ちであるはずなので、Makefileについては直接編集せずとも実行したり変数を触った経験はあるものと想定します。</p><p>本書ではソースのコンパイルとリンクはVisual Studio、XCode、EclipseなどのIDEを使わずMakefile(cmakeを使って生成)を使います。その理由としてはIDEでのライブラリーのリンクやヘッダーのインクルードの設定を省くことで想定外なエラーが発生することを抑制するためです。</p><p>Makefileをテキストファイルで編集する場合、makeがインストールされたコンパイルを自動化することにあります。</p><div class="note" style="margin-left: 0; margin-right: 10%;"><h3 class="title">注記</h3><p>IDEについて著者はEclipseとXCodeを使用しています。</p></div><p>以下のMakefileはMAC OSXでC/C++のプロジェクとをビルドするための雛形です。</p><p><strong>Makefile. </strong>
</p><pre xmlns="" class="prettyprint">SRC=basic_helloworld

LIB =
CXX = clang

CXXFLAGS= -Wall -DUNIX -g -DDEBUG
BFLAG = $(strip $(shell uname -m | grep 64))
OS = $(shell uname -s)
COMPAT = $(findstring Darwin, $(OS))


ifneq ($(COMPAT),)
        LIB += -framework OpenCL
        ifeq ($(BFLAG),)
                CXXFLAGS +=-arch i386
        else
                CXXFLAGS +=-arch x86_64
        endif
endif

$(SRC): $(SRC).cxx
        $(CXX) $(CXXFLAGS) -o $@ $^ $(LIB)

.PHONY: clean

clean:
        rm $(SRC)</pre><p>
</p><div class="table"><a id="idm24322"></a><p class="title"><strong>表C.1 makeルール内のマクロ</strong></p><div class="table-contents"><table class="table" summary="makeルール内のマクロ" cellpadding="4px" style="border-collapse: collapse;border-top: 3px solid #527bbd; border-bottom: 3px solid #527bbd; border-left: 3px solid #527bbd; border-right: 3px solid #527bbd; "><colgroup><col class="col_1" /><col class="col_2" /></colgroup><tbody><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><span class="emphasis"><em>$@</em></span></p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><span class="emphasis"><em>ルールのターゲット名</em></span></p></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><span class="emphasis"><em>$^</em></span></p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><span class="emphasis"><em>依存ファイル名、
スペースで他のファイルと区切り</em></span></p></td></tr><tr><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><p><span class="emphasis"><em>$&lt;</em></span></p></td><td style="" align="left" valign="top"><p><span class="emphasis"><em>始めの依存性</em></span></p></td></tr></tbody></table></div></div><br class="table-break" /><p>この例では、basic_helloworld.cxxというファイルから、basic_helloworldというバイナリの実行ファイルが生成されるMakefileを書いてみました。</p><p>Makefileを実行するには、ただ「make」とコマンドラインに打ち込んで頂くだけで結構です。</p><pre xmlns="" class="prettyprint">$ make
clang -Wall -DUNIX -g -DDEBUG -arch x86_64 -o basic_helloworld basic_helloworld.cxx  -framework OpenCL</pre><div class="table"><a id="idm24352"></a><p class="title"><strong>表C.2 CFLAGの一覧</strong></p><div class="table-contents"><table class="table" summary="CFLAGの一覧" cellpadding="4px" style="border-collapse: collapse;border-top: 3px solid #527bbd; border-bottom: 3px solid #527bbd; border-left: 3px solid #527bbd; border-right: 3px solid #527bbd; "><colgroup><col class="col_1" /><col class="col_2" /></colgroup><tbody><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><span class="emphasis"><em>-o filename</em></span></p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout"> 出力する実行ファイル、ライブラリを指定</pre></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><span class="emphasis"><em>-Werror</em></span></p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout"> 警告をエラーとすして表示。</pre></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><span class="emphasis"><em>-Wall</em></span></p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout"> 追加警告を表示。</pre></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><span class="emphasis"><em>-w</em></span></p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout"> 警告を抑制する。</pre></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><span class="emphasis"><em>-I dir</em></span></p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout"> インクルードしたファイルを検索するディレクトリを指定。</pre></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><span class="emphasis"><em>-L dir</em></span></p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout"> ライブラリを検索するディレクトリを指定。</pre></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><span class="emphasis"><em>-llib</em></span></p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout"> リンクしたライブラリを指定。(例：-lOpenCL)</pre></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><span class="emphasis"><em>-g</em></span></p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout"> ビルド中のデバッグ情報を表示。</pre></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><span class="emphasis"><em>-v</em></span></p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout"> ビルド中のコマンドを表示。</pre></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><span class="emphasis"><em>-O0,-O1,-O2,-O3</em></span></p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout"> 最適化の指定。数が高いほど密度のある最適化。</pre></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><span class="emphasis"><em>-E</em></span></p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout"> ファイルの前処理。コンパイルしない。</pre></td></tr><tr><td style="border-right: 1px solid #527bbd; border-bottom: 1px solid #527bbd; " align="left" valign="top"><p><span class="emphasis"><em>-S</em></span></p></td><td style="border-bottom: 1px solid #527bbd; " align="left" valign="top"><pre class="literallayout"> ファイルの前処理とコンパイル。アセンブルしない。</pre></td></tr><tr><td style="border-right: 1px solid #527bbd; " align="left" valign="top"><p><span class="emphasis"><em>-c</em></span></p></td><td style="" align="left" valign="top"><pre class="literallayout"> コンパイルとアセンブルしない。リンクしない。</pre></td></tr></tbody></table></div></div><br class="table-break" /><p>これでbasic_helloworldという実行ファイルができたので、実行してみましょう。</p><pre xmlns="" class="prettyprint">$ ./basic_helloworld
HelloWorld!!!</pre><p>このプログラムは、「HelloWorld!!!」という文字列が出力するものとし、正常に動作したことが確認できました。</p><p>最後にmakeのあとにclean引数を入力して、makeのターゲットをcleanに設定して実行ファイルを削除させることができます。</p><pre xmlns="" class="prettyprint">$ make clean
rm basic_helloworld</pre><div class="section"><div class="titlepage"><div><div><h3 class="title"><a id="_makefile_mingw"></a>C.1.1. Makefile(MinGW)</h3></div></div></div><div class="warning" style="margin-left: 0; margin-right: 10%;"><h3 class="title">警告</h3><p>本書ではMinGWはサポートしませんし（少なくとも執筆時には）未検証なので、本項目は参考程度の注意で読んでください。Windows環境で開発しない方は飛ばして結構です。Unix/Linuxに慣れすぎて、Visual Studioを避けたい場合では有効なツールではあるかと思います。</p></div><p>WindowsではVisual Studioを使わずにC/C++でのコンパイルを行なうことができます。例えば項目名となるMakefileを使うのであれば、以下の３つの選択肢が代表的なものです。</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
Cygwin
</li><li class="listitem">
MinGW (Minimalist GNU for Windows)
</li><li class="listitem">
Mingw-w64
</li></ul></div><div class="note" style="margin-left: 0; margin-right: 10%;"><h3 class="title">注記</h3><p>MinGW-w64はMinGWの64ビット拡張版です。使用したことはありませんが、他の開発者も使っていると聞いております。</p></div><p>CygwinはPOSIX環境の忠実な際限を目的とするため、コンパイラやビルドツールとしては重量すぎます。そのためコンパイラとツールのみで構成されるMinGWをインストールして使うことが良くあります。筆者もWindowsの検証環境にはMinGWと、C/C++ライブラリを配置しています。</p><p>まず公式サイトからインストーラーをダウンロードして、インストールとパス設定をしてください。</p><div class="itemizedlist"><ul class="itemizedlist" style="list-style-type: disc; "><li class="listitem">
mingw32-make、mingw32-gcc、mingw32-g++をコマンドラインで叩いてみてパスが正常に設定されているか、動作するか確認ください。
</li><li class="listitem">
MinGWをインストールしたフォルダには、「msys」というサブフォルダがあり、「msys.bat」というバッチを開くと
</li></ul></div><p>mingw32-gccはUnix/Linuxでの「gcc」に相当するものです。mingw32-makeはUnix/Linuxでの「make」（MSCVRT.dllの「make」と異なる）に相当するものです。</p><p>プログラムのビルドと動作確認をするには以下のようにすればできます。</p><pre xmlns="" class="prettyprint">&gt; mingw32-gcc -o helloworld helloworld.c
&gt; file helloworld.exe</pre><p>mingw32-makeでは、GNU makeと同様な記述ができますが、コンパイラはmingw32-gccとなることに注意ください。Makefileについては、MinGWでも「Makefile」という名称で記述します。</p><p><strong>Makefile. </strong>
</p><pre xmlns="" class="prettyprint">CC = mingw32-gcc
helloworld: helloworld.c
    $(CC) -o helloworld helloworld.c</pre><p>
</p><p>コードを奇麗にしたい場合は、以下のように自動変数を使います。</p><pre xmlns="" class="prettyprint">CC = mingw32-gcc
helloworld: helloworld.c
    $(CC) -o $@ $^</pre><p>後はMakefileを配置したフォルダをワーキングディレクトリに設定して「mingw32-make」をコマンドで叩いてコンパイルすればビルドの(部分的)自動化ができます。</p></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="apc.html">戻る</a> </td><td width="20%" align="center"><a accesskey="u" href="apc.html">上に戻る</a></td><td width="40%" align="right"> <a accesskey="n" href="apcs02.html">次へ</a></td></tr><tr><td width="40%" align="left" valign="top"> </td><td width="20%" align="center"><a accesskey="h" href="index.html">ホーム</a></td><td width="40%" align="right" valign="top"> </td></tr></table></div><wrapper xmlns=""><p>Copyright 2018-2019, by Masaki Komatsu</p>


</wrapper></body></html>